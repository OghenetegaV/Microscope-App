<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Microscope + Measurement (v2.0 Responsive)</title>
<style>
:root {
  --bg: #0f1724;
  --card: #0b1220;
  --accent: #06b6d4;
  --muted: #94a3b8;
}

html, body {
  height: 100%;
  margin: 0;
  font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica, Arial;
  background: linear-gradient(180deg, #071024 0%, #07192b 100%);
  color: #e6eef6;
}

.app {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
  width: 100%;
  max-width: 1000px;
  margin: 0 auto;
  padding: 10px;
  box-sizing: border-box;
  background: var(--card);
  border-radius: 12px;
  box-shadow: 0 8px 30px rgba(2,6,23,0.6);
}

header {
  display: flex;
  align-items: center;
  gap: 12px;
  width: 100%;
}

h1 { font-size: 18px; margin: 0; }

.grid {
  display: grid;
  grid-template-columns: 1fr 360px;
  gap: 12px;
  margin-top: 12px;
  width: 100%;
}

@media (max-width: 900px) {
  .grid { grid-template-columns: 1fr; }
}

.viewer {
  position: relative;
  width: 100%;
  background: #000;
  border-radius: 10px;
  overflow: hidden;
  aspect-ratio: 4 / 3;
}

video,
canvas.overlay,
canvas#frozenFrame {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
}

video {
  background: none;
  opacity: 1;
  z-index: 0;
}

canvas.overlay,
canvas#frozenFrame {
  background: transparent !important;
  z-index: 1;
}

.controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
  margin-top: 10px;
}

.panel {
  background: rgba(255, 255, 255, 0.02);
  padding: 12px;
  border-radius: 8px;
}

.btn {
  background: var(--accent);
  color: #062024;
  padding: 8px 10px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

.btn.secondary {
  background: transparent;
  border: 1px solid rgba(255,255,255,0.06);
  color: var(--muted);
}

.measure-list {
  max-height: 200px;
  overflow: auto;
  padding: 6px;
  font-size: 13px;
  border-radius: 6px;
  background: rgba(0,0,0,0.15);
}

.small { font-size: 12px; color: var(--muted); }

footer {
  font-size: 12px;
  color: var(--muted);
  margin-top: 8px;
}

@media (max-width: 768px) {
  .viewer {
    width: 100%;
    height: 60vh;
    aspect-ratio: auto;
  }
  .app { padding: 5px; }
  .controls { gap: 6px; }
}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Microscope + Measurement — Image Analysis Tool</h1>
    <div style="margin-left:auto" class="small">Freeze for stable calibration</div>
  </header>

  <div class="grid">
    <div>
      <div class="viewer">
        <video id="video" autoplay playsinline></video>
        <canvas id="frozenFrame"></canvas>
        <canvas id="overlay" class="overlay"></canvas>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
        <button id="freezeBtn" class="btn">Freeze</button>
        <button id="captureBtn" class="btn">Capture</button>
        <button id="clearBtn" class="btn secondary">Clear</button>
        <button id="exportBtn" class="btn secondary">Export CSV</button>
      </div>

      <div class="panel" style="margin-top:8px">
        <div class="small">Digital Zoom</div>
        <div style="display:flex;align-items:center;gap:6px;">
          <button id="zoomOutBtn" class="btn secondary" style="width:36px;">−</button>
          <input id="zoomRange" type="range" min="1" max="64" step="0.1" value="1" style="flex:1;">
          <button id="zoomInBtn" class="btn secondary" style="width:36px;">+</button>
        </div>
        <div class="small">Current Zoom: <span id="zoomDisplay">1×</span></div>
      </div>
    </div>

    <aside class="controls">
      <div class="panel">
        <div class="small"><strong>Calibration</strong></div>
        <div class="small" style="margin-top:6px">Click two points on a known-length reference, then enter distance (mm).</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button id="calModeBtn" class="btn secondary">Enter Calibrate Mode</button>
          <button id="resetCalBtn" class="btn secondary">Reset</button>
        </div>
        <div style="margin-top:8px">
          <label class="small">Pixels per mm:</label>
          <div id="pxPerMm" style="font-weight:700">—</div>
          <label class="small">True Magnification:</label>
          <div id="trueMag" style="font-weight:700">—</div>
        </div>
      </div>

      <div class="panel">
        <div class="small"><strong>Measurement</strong></div>
        <div class="small" style="margin-top:6px">Click two points across crack to measure width.</div>
        <div style="display:flex;gap:6px;margin-top:8px">
          <button id="measureModeBtn" class="btn">Measure</button>
          <button id="saveMeasureBtn" class="btn secondary">Save</button>
        </div>
        <div style="margin-top:8px">
          <label class="small">Saved Measurements (mm)</label>
          <div id="measureList" class="measure-list"></div>
        </div>
      </div>

      <footer>v2.0 — Responsive, calibrated, and export-ready.</footer>
    </aside>
  </div>
</div>

<script>
(async function(){
  const video=document.getElementById('video'),
        overlay=document.getElementById('overlay'),
        frozenCanvas=document.getElementById('frozenFrame'),
        ctx=overlay.getContext('2d'),
        frozenCtx=frozenCanvas.getContext('2d');

  const freezeBtn=document.getElementById('freezeBtn'),
        zoomRange=document.getElementById('zoomRange'),
        zoomDisplay=document.getElementById('zoomDisplay'),
        trueMagEl=document.getElementById('trueMag'),
        pxPerMmEl=document.getElementById('pxPerMm'),
        calModeBtn=document.getElementById('calModeBtn'),
        resetCalBtn=document.getElementById('resetCalBtn'),
        measureModeBtn=document.getElementById('measureModeBtn'),
        saveMeasureBtn=document.getElementById('saveMeasureBtn'),
        clearBtn=document.getElementById('clearBtn'),
        captureBtn=document.getElementById('captureBtn'),
        exportBtn=document.getElementById('exportBtn'),
        zoomOutBtn=document.getElementById('zoomOutBtn'),
        zoomInBtn=document.getElementById('zoomInBtn'),
        measureListEl=document.getElementById('measureList');

  let stream=null,isFrozen=false,currentMode=null,
      calibration={pixels:null,mm:null,pxPerMm:null},
      points=[],saved=[],trueMag=1;

  function fitCanvas(){
    const w=overlay.clientWidth,h=overlay.clientHeight;
    [overlay,frozenCanvas].forEach(c=>{c.width=w;c.height=h;});
  }

  async function startCamera(){
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1280 },
          height: { ideal: 960 }
        },
        audio: false
      });
      video.srcObject = stream;
      video.muted = true;
      video.setAttribute('playsinline', true);

      // Important: ensure sizing updates when metadata is ready
      video.addEventListener('loadedmetadata', () => {
        console.log("Camera feed loaded:", video.videoWidth, "x", video.videoHeight);
        fitCanvas();
      });

      await video.play();
      console.log("Camera started successfully.");
    } catch (err) {
      console.error("Camera access error:", err);
      alert("Camera access blocked or unavailable. Please allow permissions.");
    }
  }

  await startCamera();

  // --- Rest of your measurement and overlay logic unchanged ---
  freezeBtn.onclick = () => {
    if (!isFrozen) {
      fitCanvas();
      const vRatio = video.videoWidth / video.videoHeight;
      const boxRatio = video.clientWidth / video.clientHeight;
      let sx, sy, sw, sh;
      if (vRatio > boxRatio) {
        sh = video.videoHeight;
        sw = sh * boxRatio;
        sx = (video.videoWidth - sw) / 2;
        sy = 0;
      } else {
        sw = video.videoWidth;
        sh = sw / boxRatio;
        sx = 0;
        sy = (video.videoHeight - sh) / 2;
      }
      frozenCtx.clearRect(0, 0, frozenCanvas.width, frozenCanvas.height);
      frozenCtx.drawImage(video, sx, sy, sw, sh, 0, 0, frozenCanvas.width, frozenCanvas.height);
      frozenCanvas.style.display = 'block';
      video.style.display = 'none';
      freezeBtn.textContent = 'Unfreeze';
      isFrozen = true;
    } else {
      frozenCanvas.style.display = 'none';
      video.style.display = 'block';
      freezeBtn.textContent = 'Freeze';
      isFrozen = false;
    }
  };

  // Zoom control
  zoomRange.addEventListener('input', updateZoom);
  zoomOutBtn.onclick = () => { zoomRange.value = Math.max(1, Number(zoomRange.value) - 0.5); updateZoom(); };
  zoomInBtn.onclick = () => { zoomRange.value = Math.min(64, Number(zoomRange.value) + 0.5); updateZoom(); };

  function updateZoom(){
    const z = Number(zoomRange.value);
    video.style.transform = `scale(${z})`;
    frozenCanvas.style.transform = `scale(${z})`;
    zoomDisplay.textContent = z.toFixed(1) + '×';
    updateMagnification();
  }

  function updateMagnification(){
    if(!calibration.pxPerMm){trueMagEl.textContent='—';trueMag=1;return;}
    const screenPPI = window.devicePixelRatio * 96;
    const screenPxPerMm = screenPPI / 25.4;
    trueMag = (calibration.pxPerMm / screenPxPerMm) * Number(zoomRange.value);
    trueMagEl.textContent = trueMag.toFixed(1) + '×';
  }

  function draw(){
    ctx.clearRect(0,0,overlay.width,overlay.height);
    // Crosshair + tick lines
    const cx=overlay.width/2,cy=overlay.height/2,tickSpacing=10,tickLen=4;
    ctx.strokeStyle='rgba(255,255,255,0.5)';ctx.lineWidth=1;
    ctx.beginPath();ctx.moveTo(0,cy);ctx.lineTo(overlay.width,cy);
    ctx.moveTo(cx,0);ctx.lineTo(cx,overlay.height);ctx.stroke();

    // Date, time, zoom overlay
    const now=new Date(),dateStr=now.toLocaleDateString(),timeStr=now.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const zoomText=`${trueMag.toFixed(1)}×`;
    ctx.fillStyle='#fff';ctx.font='12px monospace';ctx.textAlign='right';
    ctx.fillText(`${dateStr} ${timeStr}`,overlay.width-10,20);
    ctx.fillText(`Zoom: ${zoomText}`,overlay.width-10,36);
  }

  requestAnimationFrame(function loop(){draw();requestAnimationFrame(loop);});
})();
</script>
</body>
</html>
